name: Deploy Web Assembly

on:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Job de validação e testes
  validate:
    name: Validate & Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.1"
          cache: true

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev libgl1-mesa-dev libxcursor-dev libxi-dev libxinerama-dev libxrandr-dev libxxf86vm-dev libx11-dev pkg-config

      - name: Download dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      - name: Run go vet
        run: go vet ./...

      - name: Run go fmt
        run: |
          if [ -n "$(gofmt -s -l .)" ]; then
            echo "Go code is not formatted:"
            gofmt -s -d .
            exit 1
          fi

      - name: Build native version
        run: go build -v -o game .

  # Job de build e deploy
  deploy:
    name: Build & Deploy WebAssembly
    needs: validate
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.1"
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Build WebAssembly
        run: |
          GOOS=js GOARCH=wasm go build -v -ldflags="-s -w" -o web/game.wasm .
        
      - name: Copy wasm_exec.js
        run: cp $(go env GOROOT)/misc/wasm/wasm_exec.js web/

      - name: List web directory
        run: ls -lah web/
      - name: Note: deploy disabled in this workflow
        run: |
          echo "This workflow performs validation and builds the web assembly but DOES NOT upload or deploy the artifact."
          echo "Use the main 'Deploy to GitHub Pages' workflow to upload and deploy the _site artifact."
